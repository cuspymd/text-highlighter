# 동기화 기능 요구 사항 (Sync Feature Requirements)

## 1. 개요

동일 브라우저 계정으로 로그인한 여러 기기 간에 하이라이트 데이터와 설정을 자동으로 동기화한다.

### 1.1 동기화 대상

| 데이터 종류 | 설명 |
|---|---|
| **하이라이트** | 페이지별 하이라이트 (텍스트, 색상, 위치) |
| **커스텀 색상** | 사용자가 추가한 사용자 정의 색상 목록 |
| **미니맵 표시 설정** | 미니맵 보이기/숨기기 |
| **선택 컨트롤 표시 설정** | 선택 컨트롤 보이기/숨기기 |

### 1.2 동기화 제약 사항

- 동기화 저장 공간에는 용량 제한이 있다.
- 한 페이지의 하이라이트 데이터가 너무 크면 해당 페이지는 동기화되지 않고 해당 기기에서만 유지된다.
- 전체 동기화 용량이 초과되면 가장 오래전에 수정된 페이지부터 동기화 대상에서 제외된다. 제외된 페이지의 하이라이트는 해당 기기에서 삭제되지 않는다.

### 1.3 기본 원칙

- **로컬 우선**: 동기화 실패 시에도 해당 기기에서의 모든 기능은 정상 동작한다.
- **최종 일관성**: 모든 기기가 최종적으로 동일한 상태에 수렴한다.
- **데이터 보존**: 동기화로 인해 사용자의 하이라이트가 의도치 않게 삭제되지 않는다.

---

## 2. 단일 기기 시나리오 (Single Device)

### S-1. 하이라이트 생성

| 항목 | 내용 |
|---|---|
| **사용자 행동** | 웹 페이지에서 텍스트를 선택하고 색상을 지정하여 하이라이트 생성 |
| **기대 결과** | 하이라이트가 즉시 페이지에 표시되고, 저장되어 다음 방문 시에도 유지된다. 동기화 대상에 포함된다. |

### S-2. 하이라이트 삭제 (개별)

| 항목 | 내용 |
|---|---|
| **사용자 행동** | 특정 하이라이트를 선택하여 삭제 |
| **기대 결과** | 해당 하이라이트가 페이지에서 즉시 사라지고, 동기화 데이터에서도 제거된다. |

### S-3. 특정 페이지의 모든 하이라이트 삭제

| 항목 | 내용 |
|---|---|
| **사용자 행동** | 특정 페이지의 모든 하이라이트를 한꺼번에 삭제 |
| **기대 결과** | 해당 페이지의 모든 하이라이트가 사라지고, 하이라이트 페이지 목록에서도 제거된다. 동기화 데이터에서도 삭제된다. |

### S-4. 전체 하이라이트 페이지 일괄 삭제

| 항목 | 내용 |
|---|---|
| **사용자 행동** | 모든 페이지의 하이라이트를 한꺼번에 삭제 |
| **기대 결과** | 모든 하이라이트 데이터가 삭제되고, 하이라이트 페이지 목록이 비워진다. 동기화 데이터도 전부 삭제된다. |

### S-5. 페이지 재방문 시 하이라이트 복원

| 항목 | 내용 |
|---|---|
| **사용자 행동** | 이전에 하이라이트를 추가한 페이지를 다시 방문 |
| **기대 결과** | 저장된 하이라이트가 원래 위치에 원래 색상으로 복원되어 표시된다. |

### S-6. 커스텀 색상 추가

| 항목 | 내용 |
|---|---|
| **사용자 행동** | 색상 선택기를 사용하여 새로운 사용자 정의 색상 추가 |
| **기대 결과** | 새 색상이 색상 목록과 컨텍스트 메뉴에 즉시 나타난다. 모든 열린 탭에서 새 색상을 사용할 수 있다. 동기화 대상에 포함된다. |

### S-7. 커스텀 색상 초기화

| 항목 | 내용 |
|---|---|
| **사용자 행동** | 모든 사용자 정의 색상을 삭제 |
| **기대 결과** | 기본 5가지 색상만 남고, 컨텍스트 메뉴와 색상 패널이 기본 상태로 돌아간다. 동기화 데이터에서도 커스텀 색상이 제거된다. |

### S-8. 설정 변경 (미니맵/선택 컨트롤 표시 여부)

| 항목 | 내용 |
|---|---|
| **사용자 행동** | 팝업에서 미니맵 또는 선택 컨트롤 보이기/숨기기 토글 |
| **기대 결과** | 설정이 즉시 모든 열린 탭에 반영된다. 동기화 대상에 포함된다. |

### S-9. 확장 프로그램 설치/업데이트

| 항목 | 내용 |
|---|---|
| **사용자 행동** | 확장 프로그램을 처음 설치하거나 새 버전으로 업데이트 |
| **기대 결과** | 이미 동기화 저장소에 데이터가 있으면 (다른 기기에서 사용 중이었다면) 자동으로 불러와 즉시 사용 가능하다. 기존 로컬 데이터가 있으면 동기화 저장소에 업로드된다. |

### S-10. 동기화 용량 초과

| 항목 | 내용 |
|---|---|
| **사용자 행동** | 많은 페이지에 하이라이트를 추가하여 동기화 용량 한도를 초과 |
| **기대 결과** | 가장 오래전에 수정된 페이지부터 동기화 대상에서 제외된다. 해당 기기에서의 하이라이트는 그대로 유지되며, 사용자가 느끼는 변화는 없다. 동기화 대상에서 제외된 페이지의 하이라이트는 다른 기기에서 볼 수 없다. |

### S-11. 한 페이지의 하이라이트가 너무 큰 경우

| 항목 | 내용 |
|---|---|
| **사용자 행동** | 한 페이지에 매우 많은 하이라이트를 추가하여 단일 항목 용량 한도 초과 |
| **기대 결과** | 해당 페이지의 하이라이트는 현재 기기에서 정상 동작하지만 다른 기기로 동기화되지 않는다. |

---

## 3. 멀티 디바이스 시나리오 (Multi-Device)

동일 계정으로 로그인한 기기A와 기기B 사이의 동기화 시나리오.

### M-1. 새 기기에서 처음 사용

| 항목 | 내용 |
|---|---|
| **전제** | 기기A에서 하이라이트와 설정을 사용 중. 기기B에 확장 프로그램을 처음 설치 |
| **기대 결과** | 기기B에서 확장 프로그램이 시작되면 기기A의 하이라이트와 설정이 자동으로 반영된다. 기기B에서 기기A에서 하이라이트한 페이지를 열면 하이라이트가 표시된다. |

### M-2. 한 기기에서 하이라이트 추가 → 다른 기기로 전파

| 항목 | 내용 |
|---|---|
| **전제** | 기기A와 기기B 모두 확장 프로그램 사용 중 |
| **기대 결과** | 기기A에서 하이라이트를 추가하면, 기기B에서 해당 페이지를 열거나 이미 열려 있을 때 새 하이라이트가 표시된다. |

### M-3. 한 기기에서 하이라이트 삭제 → 다른 기기로 전파

| 항목 | 내용 |
|---|---|
| **전제** | 양쪽 기기에 동일한 하이라이트가 존재 |
| **기대 결과** | 기기A에서 특정 하이라이트를 삭제하면, 기기B에서도 해당 하이라이트가 사라진다. 기기B에서 해당 페이지가 열려 있으면 즉시 반영된다. |

### M-4. 한 기기에서 모든 하이라이트 삭제 → 다른 기기로 전파

| 항목 | 내용 |
|---|---|
| **전제** | 기기A에서 특정 페이지의 모든 하이라이트를 삭제 |
| **기대 결과** | 기기B에서도 해당 페이지의 모든 하이라이트가 삭제된다. 기기B에서 페이지가 열려 있으면 즉시 반영된다. |

### M-5. 한 기기에서 전체 페이지 일괄 삭제 → 다른 기기로 전파

| 항목 | 내용 |
|---|---|
| **전제** | 기기A에서 모든 하이라이트 페이지를 일괄 삭제 |
| **기대 결과** | 기기B에서도 모든 동기화된 하이라이트 데이터가 삭제된다. |

### M-6. 동시 편집 — 같은 페이지에 다른 하이라이트 추가

| 항목 | 내용 |
|---|---|
| **전제** | 기기A와 기기B가 같은 페이지에서 거의 동시에 서로 다른 텍스트를 하이라이트 |
| **기대 결과** | 양쪽 기기 모두에 두 하이라이트가 모두 표시된다 (합집합). 어느 쪽 하이라이트도 유실되지 않는다. |

### M-7. 동시 편집 — 같은 하이라이트의 색상을 서로 다르게 변경

| 항목 | 내용 |
|---|---|
| **전제** | 기기A와 기기B가 같은 하이라이트의 색상을 거의 동시에 서로 다른 색으로 변경 |
| **기대 결과** | 나중에 변경한 쪽의 색상이 양쪽 모두에 적용된다 (마지막 수정 우선). 최종적으로 양쪽 기기가 동일한 색상을 표시한다. |

### M-8. 한 기기에서 설정 변경 → 다른 기기로 전파

| 항목 | 내용 |
|---|---|
| **전제** | 기기A에서 미니맵 숨김 설정 |
| **기대 결과** | 기기B에서도 미니맵이 숨겨진다. 기기B에서 열려 있는 탭에 즉시 반영된다. |

### M-9. 한 기기에서 커스텀 색상 추가 → 다른 기기로 전파

| 항목 | 내용 |
|---|---|
| **전제** | 기기A에서 새 사용자 정의 색상을 추가 |
| **기대 결과** | 기기B의 색상 패널과 컨텍스트 메뉴에 새 색상이 자동으로 나타난다. |

### M-10. 오프라인에서 작업 후 온라인 복귀

| 항목 | 내용 |
|---|---|
| **전제** | 기기A가 오프라인 상태에서 하이라이트를 추가하거나 삭제 |
| **기대 결과** | 오프라인 중에도 모든 기능이 정상 동작한다. 온라인에 복귀하면 오프라인 중 작업한 내용이 자동으로 동기화된다. 다른 기기에서의 변경사항도 병합되어 반영된다. 양쪽 기기가 동일한 상태로 수렴한다. |

### M-11. 양쪽 기기에서 같은 페이지가 열린 상태에서 한쪽이 삭제

| 항목 | 내용 |
|---|---|
| **전제** | 기기A와 기기B 모두 같은 페이지를 보고 있는 상태에서 기기A가 하이라이트를 삭제 |
| **기대 결과** | 기기B에서 보고 있는 페이지에서도 삭제된 하이라이트가 즉시 사라진다. |

### M-12. 동기화 용량 초과로 오래된 데이터가 동기화 대상에서 제외될 때

| 항목 | 내용 |
|---|---|
| **전제** | 기기A에서 새 하이라이트를 저장할 때 동기화 용량이 초과되어 오래된 페이지가 동기화 대상에서 제외됨 |
| **기대 결과** | 기기A에서는 제외된 페이지의 하이라이트가 그대로 유지된다. 기기B에서도 이미 보유한 해당 페이지의 하이라이트가 삭제되지 않는다. 단, 동기화 대상에서 제외된 페이지는 이후 새 기기에서 볼 수 없다. |

### M-13. 확장 프로그램 버전이 다른 경우

| 항목 | 내용 |
|---|---|
| **전제** | 기기A는 동기화 지원 최신 버전, 기기B는 동기화 미지원 구버전 |
| **기대 결과** | 기기B에 영향 없이 기존대로 동작한다. 기기B를 업데이트하면 기기A의 데이터가 자동으로 반영된다. |

### M-14. 한 기기에서 하이라이트 추가 + 다른 기기에서 같은 페이지의 다른 하이라이트 삭제

| 항목 | 내용 |
|---|---|
| **전제** | 기기A에서 새 하이라이트 추가, 거의 동시에 기기B에서 같은 페이지의 기존 하이라이트 삭제 |
| **기대 결과** | 양쪽 모두에 기기A의 새 하이라이트가 표시되고, 기기B가 삭제한 하이라이트는 양쪽 모두에서 사라진다. 추가와 삭제가 각각 독립적으로 반영된다. |

---

## 4. 충돌 해결 원칙

### 4.1 하이라이트 병합

| 상황 | 처리 방식 |
|---|---|
| 한쪽에만 존재하는 하이라이트 (추가) | 양쪽 모두에 포함 |
| 양쪽에 동일한 하이라이트가 존재 (동일) | 나중에 수정된 쪽의 데이터 채택 |
| 한쪽에서 삭제되고 다른 쪽에서 수정 없음 (삭제) | 삭제가 반영됨 |
| 한쪽에서 삭제되었지만 다른 쪽에서 새로 추가 (독립적 작업) | 각각 독립적으로 반영 |

### 4.2 설정 충돌

설정(커스텀 색상, 미니맵 등)은 마지막에 변경한 값이 모든 기기에 적용된다 (마지막 수정 우선).

### 4.3 동기화 대상 제외 vs 사용자 삭제

- **사용자가 명시적으로 삭제**: 모든 기기에서 삭제가 반영된다.
- **용량 초과로 동기화 대상에서 제외**: 어떤 기기에서도 하이라이트가 삭제되지 않는다. 해당 기기에 이미 있는 데이터는 유지된다.
